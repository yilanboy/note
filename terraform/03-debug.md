---
layout: default
parent: Terraform
nav_order: 3
---

# åˆ†äº«å‰è¼©çš„ Terraform Debug å°æŠ€å·§

å‰å¹¾å¤© Azure åˆå®³æˆ‘åŠ ç­äº†ï¼Œä¸€æ€’ä¹‹ä¸‹ï¼Œæˆ‘æ±ºå®šå¯«ä¸€ç¯‡æ–‡ç« å®£æ´©æƒ…ç·’å¤–åŠ ç´€éŒ„é€™æ¬¡å‰è¼©æ•™æˆ‘çš„ Terraform Debug å°æŠ€å·§ã€‚

äº‹æƒ…æ˜¯é€™æ¨£çš„ï¼Œæˆ‘ä½¿ç”¨ Terraform éƒ¨ç½²ä¸€å€‹ Azure çš„ Role Assignment è³‡æºæ™‚ï¼š

```hcl
# å‡ç¯„ä¾‹ä¸€æš
resource "azurerm_role_assignment" "network_config_reader" {
  scope                = azurerm_storage_container.network_config.id
  role_definition_name = "Storage Blob Data Reader"
  principal_id         = azurerm_user_assigned_identity.router.principal_id
}
```

æœƒå‡ºç¾ä¸€å€‹å¥‡æ€ªçš„éŒ¯èª¤ï¼š

```text
The request did not have a subscription or a valid tenant level resource provider.
```

çœ‹åˆ°è¨Šæ¯æˆ‘ä»¥ç‚ºæ˜¯æœ‰ä»€éº¼è³‡æºçš„å±¬æ€§æ²’æœ‰å¯«ä¸Šï¼Œä½†ç¢ºèªäº†ä¸€ä¸‹æ–‡ä»¶ï¼Œç™¼ç¾èªæ³•æ²’æœ‰å¯«éŒ¯å¾Œï¼Œæˆ‘é–‹å§‹æ‡·ç–‘æ˜¯ä¸æ˜¯ Terraform èƒŒå¾Œçš„ Azure Provider æœ‰ä»€éº¼å¥‡æ€ªçš„ Bug äº†...

> æ²’è¾¦æ³•ï¼ŒAzure éå»å‚·æˆ‘å‚·å¾—å¾ˆæ·±ã€‚ğŸ¥²

## é–‹å•Ÿ Terraform çš„ Logs

é›–ç„¶å°å•é¡Œçš„åŸå› æœ‰æƒ³æ³•ï¼Œä½†æˆ‘å»ä¸çŸ¥é“è©²å¦‚ä½•å°‹æ‰¾åˆ°åº•æ˜¯å“ªé‚Šå‡ºå•é¡Œã€‚é€™æ™‚å€™å‰è¼©è·Ÿæˆ‘èªªå¯ä»¥å…ˆé–‹å•Ÿ Terraform çš„ Logs ï¼ˆæ—¥èªŒï¼‰ä¾†çœ‹çœ‹ã€‚

Terraform æ˜¯é€é Provider ä¾†æ“ä½œé›²ç«¯è³‡æºï¼Œé€™èƒŒå¾Œçš„åŸç†ä¹Ÿå¾ˆç°¡å–®ï¼Œå°±æ˜¯å‘¼å«é›²ç«¯æä¾›çš„ APIã€‚æ‰€ä»¥å‰è¼©çŒœæ¸¬å¯èƒ½æ˜¯ Provider åœ¨çµ„åˆ API éœ€è¦çš„è³‡è¨Šæ™‚å‡ºäº†ä»€éº¼å•é¡Œï¼Œå°è‡´å‘¼å« API æ™‚å‡ºç¾éŒ¯èª¤ã€‚

å¦‚æœæƒ³é–‹å•Ÿ Terraform Logsï¼Œåªè¦å®£å‘Šä¸€å€‹ç’°å¢ƒè®Šæ•¸å³å¯ã€‚

```bash
export TF_LOG=DEBUG
```

> Qï¼šåœ¨ Shell Script ä¸­å®£å‘Šè®Šæ•¸æ™‚ï¼ŒåŠ ä¸åŠ  `export` æœ‰ä»€éº¼å·®åˆ¥ï¼Ÿ
>
> Aï¼šä¸åŠ  `export` ç‚ºå±€éƒ¨è®Šæ•¸ï¼Œé€™ç¨®è®Šæ•¸åªåœ¨ç•¶å‰ Shell ç’°å¢ƒä¸­æœ‰æ•ˆã€‚åŠ ä¸Š `export` ç‚ºç’°å¢ƒè®Šæ•¸ï¼Œé€™ç¨®è®Šæ•¸æœƒè¢«ç•¶å‰ Shell ç’°å¢ƒåŠå…¶æ‰€æœ‰å­ Shell ç’°å¢ƒæ‰€ç¹¼æ‰¿ã€‚
>
> ç•¶ä½  `export` ä¸€å€‹è®Šæ•¸å¾Œï¼Œæ‰€æœ‰ç”±ç•¶å‰ Shell å•Ÿå‹•çš„å­é€²ç¨‹ï¼ˆåŒ…æ‹¬è…³æœ¬ã€å…¶ä»–å‘½ä»¤ç­‰ï¼‰éƒ½å¯ä»¥å­˜å–åˆ°é€™å€‹è®Šæ•¸çš„å€¼ã€‚

ç’°å¢ƒè®Šæ•¸å®£å‘Šå¾Œï¼Œå¯ä»¥å†æ¬¡å˜—è©¦ä½¿ç”¨ Terraform ä¾†éƒ¨ç½²è³‡æºã€‚é€™æ™‚å€™ä½ å°±æœƒç™¼ç¾ Terraform åœ¨ç¢ºèªéƒ¨ç½²è¨ˆåŠƒæ™‚ï¼Œæœƒå™´å‡ºä¸€å¤§å †çš„æ—¥èªŒã€‚

é€™äº›æ—¥èªŒä¸­å°±åŒ…å« Provider æ˜¯å¦‚ä½•å‘¼å«é›²ç«¯ API ä¾†æ“ä½œè³‡æºçš„è³‡è¨Šã€‚

ä¸€èˆ¬ä¾†èªªçµ‚ç«¯æ©Ÿè¦–çª—éƒ½æœ‰é¡¯ç¤ºè¡Œæ•¸çš„ä¸Šé™ï¼Œå¦‚æœä½ çš„é›²ç«¯è³‡æºæ¯”è¼ƒå¤šçš„è©±ï¼Œå¯èƒ½æœƒå› ç‚ºå™´å‡ºçš„æ—¥èªŒå¤ªå¤šè€Œç„¡æ³•çœ‹åˆ°æ¯”è¼ƒä¸€é–‹å§‹çš„æ—¥èªŒã€‚é€™æ™‚å€™å¯ä»¥è€ƒæ…®å°‡æ‰€æœ‰çš„æ—¥èªŒéƒ½åŒ¯å‡ºåˆ°æª”æ¡ˆä¸­ã€‚

é€™éœ€è¦å®£å‘Šå¦å¤–ä¸€å€‹ç’°å¢ƒè®Šæ•¸ã€‚

```bash
export TF_LOG_PATH='./debug.txt'
```

é€™æ¨£å°±å¯ä»¥å°‡é€™ä¸€å¤§å †æ—¥èªŒåŒ¯å‡ºåˆ° `debug.txt` é€™å€‹æª”æ¡ˆäº†ï¼Œé¿å…çµ‚ç«¯æ©Ÿè¦–çª—è¡Œæ•¸ä¸Šé™çš„å•é¡Œã€‚

## é–‹å§‹æŠ“é¬¼

ä»”ç´°æŸ¥çœ‹ `debug.txt` çš„å…§å®¹ï¼Œå‰è¼©è·Ÿæˆ‘ç™¼ç¾äº†æŸä¸€è¡Œæ—¥èªŒå‡ºç¾äº†ä¸€å€‹å¾ˆæœ‰è¶£çš„ç¶²å€ã€‚

```text
025-05-23T18:58:17.172+0800 [DEBUG] provider.terraform-provider-azurerm_v4.30.0_x5: [DEBUG] GET https://management.azure.com/https://examplestorage.blob.core.windows.net/examplecontainer/providers/Microsoft.Authorization/roleDefinitions?$filter=roleName+eq+'Storage+Blob+Data+Reader'&api-version=2022-05-01-preview
```

é€™å€‹ç¶²å€æ˜¯ä»€éº¼é¬¼ï¼Ÿå…©å€‹ `https://` é€£åœ¨ä¸€èµ·ï¼Œé€™ä¸€çœ‹å°±æœ‰å•é¡Œå•Šã€‚ğŸ˜‚

æˆ‘è©¦è©¦çœ‹ç”¨ `terraform console` ä¾†æ¯”å°ä¸€ä¸‹æœ‰å•é¡Œçš„èˆ‡æ­£å¸¸çš„ `azurerm_role_assignment` è³‡æºï¼Œçœ‹çœ‹ä»–å€‘çš„ `state` è³‡è¨Šæ˜¯å¦æœ‰å·®ç•°ã€‚

çµæœ ...

é¦–å…ˆçœ‹çœ‹**æœ‰å•é¡Œ** `azurerm_role_assignment` çš„ `state` è³‡è¨Šã€‚

```json
{
  // ...
  "id": "https://examplestorage.blob.core.windows.net/examplecontainer"
  // ...
}
```

å†ä¾†çœ‹çœ‹**æ­£å¸¸** azurerm_role_assignment çš„ state è³‡è¨Šã€‚

```json
{
  // ...
  "id": "subscriptions/xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxxx/resourceGroups/..."
  // ...
}
```

å…‡æ‰‹å¾ˆæ˜é¡¯äº†ï¼ŒåŸå› æ˜¯åœ¨å‡ç´š Provider ä¹‹å¾Œï¼Œæ²’æœ‰æ³¨æ„åˆ° `id` çš„æ ¼å¼æœ‰ç ´å£æ€§æ›´æ–°ï¼Œå°è‡´ Terraform åœ¨ä½¿ç”¨èˆŠ `id` æ ¼å¼å‘¼å« API æ™‚æœƒå‡ºç¾æ ¼å¼å‡ºéŒ¯çš„å•é¡Œã€‚é€™å€‹å•é¡Œçš„è§£æ±ºæ–¹å¼ä¹Ÿå¾ˆç°¡å–®ï¼Œåœ¨ç¢ºèªè³‡æºä¸æœƒå½±éŸ¿åˆ°å…¶ä»–è³‡æºå¾Œï¼Œå°‡å…¶ç æ‰é‡æ–°éƒ¨ç½²å³å¯ã€‚

åªèƒ½èªªé‚„æ˜¯ç†Ÿæ‚‰çš„ Azure å•Šï¼Œå‹•ä¸å‹•å°±æœ‰å¥‡æ€ªçš„ç ´å£æ€§æ›´æ–°å‡ºç¾ã€‚ğŸ˜®â€ğŸ’¨

> æ­£ç¾©çš„è²éŸ³ï¼šå•é¡Œæ‡‰è©²æ˜¯ä½ æ²’æœ‰æª¢æŸ¥ç ´å£æ€§æ›´æ–°å°±äº‚å‡ç´š Provider çš„å¤§ç‰ˆæœ¬å§ï¼
>
> æˆ‘ï¼šæˆ‘åªæ˜¯æƒ³è‡­ä¸€ä¸‹ Azureã€‚

## åƒè€ƒè³‡æ–™

- [Enable Terraform logs](https://developer.hashicorp.com/terraform/internals/debugging)
